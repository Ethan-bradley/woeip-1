{% extends '__base.html' %}
{% block content %}

<font size="5" color="green" style="margin-left:5%" >Upload data</font>


<form name="form" enctype="multipart/form-data" action="{% url 'upload' %}" method="POST">
<div id="output" style="min-height: 200px; white-space: pre;
     border: 2px dashed grey; margin-left:5%; margin-right:5%;"

     ondragenter="
     document.getElementById('output').textContent = 'Let go.'; event.stopPropagation(); event.preventDefault(); "
     ondragover="event.stopPropagation(); event.preventDefault();"
     ondrop="event.stopPropagation(); event.preventDefault();
     doDrop(event);">
     <div align="center" color="grey">Drop your files here <br> <font size="1">
     Files must be from DusTrak and GPS devices. </font>
 </div>

</div>

<br>
<br>



<!-- Manual Upload Form-->
<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  {{ form.as_p }}
  <button type="submit">Submit</button>
</form>

<div class="input-container">
  <input type="file" id="real-input" multiple="">
  <button class="browse-btn">
    Find Files on your computer.
  </button>
  <span class="file-info"></span>
</div>

<!-- Code for drag and drop -->
<script type="text/javascript">
//Script for manual upload form:
const uploadButton = document.querySelector('.browse-btn');
const fileInfo = document.querySelector('.file-info');
const realInput = document.getElementById('real-input');

uploadButton.addEventListener('click', () => {
  realInput.click();
});

realInput.addEventListener('change', () => {
  const name = realInput.value.split(/\\|\//).pop();
  const truncated = name.length > 20 
    ? name.substr(name.length - 20) 
    : name;
  
  fileInfo.innerHTML = truncated;
});


//Everything else:
    Array.prototype.contains = function ( needle ) {
       var array = this;
       for (var i in array) {
          if (array[i] == needle) return true;
       }
       return false;
    };
    function ondrag(event)
    {
        displayText("Let go.");
    }
    function doDrop(event)
    {
      var maxFileSize = 100000000000000000000000000000000000000000000000000000000000000000000000000000;
      var count = 0;
      var dt = event.dataTransfer;
      var files = dt.files;
      var fileIndices = [null, null];
      fileCount = files.length;
      displayText("File Count: " + fileCount + "\n");
      if (fileCount == 2) {
        for (var i = 0; i < fileCount; i++) {
            extension = getExt(files[i].name);
            if (extension == 'log') {
                fileIndices[0] = i;
            } else if (extension == 'csv') {
                fileIndices[1] = i;
            }
        }
        if (~fileIndices.contains(null)) {
            displayText("Uploading...");
            if (calculateFileSize(files) < maxFileSize) {
                air_quality = files[fileIndices[1]];
                gps = files[fileIndices[0]];
                createPost(air_quality,gps);
            } else {
                displayText("File size is larger than max file size.");
            }
        } else {
            displayText("Incorrect file types. Takes 1 csv and 1 gps log file.");
        }
        }
    }
    function calculateFileSize(files)
    {
        var totalsize = 0;
        for (var i=0; i < files.length; i++) {
            totalsize += files[i].size;
        }
        return totalsize;
    }
    function displayText(text) {
      document.getElementById("output").textContent = text;
    }
    //Gets extension for the file
    function getExt(filename) {
        return (/[.]/.exec(filename)) ? /[^.]+$/.exec(filename) : undefined;
    }
    // AJAX for posting
    function createPost(air_quality,gps) {
        console.log("create post is working!");
        /*$.ajax({
            url : "/files/upload/", // the endpoint
            type : "POST", // http method
            data : { air_Quality : air_quality }, // data sent with the post request
            processData: false,
            contentType: false,
            // handle a successful response
            success : function(json) {
                console.log(json); // log the returned json to the console
                console.log("success");
            },
            // handle a non-successful response
            error : function(xhr,errmsg,err) {
                $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                    " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            }
        });
        $.ajax({
            url : "/files/upload/", // the endpoint
            type : "POST", // http method
            data : { GPS : gps }, // data sent with the post request
            processData: false,
            contentType: false,
            // handle a successful response
            success : function(json) {
                $('#post-text').val(''); // remove the value from the input
                console.log(json); // log the returned json to the console
                console.log("success");
            },
            // handle a non-successful response
            error : function(xhr,errmsg,err) {
                $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                    " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            }
        });*/
    }
</script>

<style type="text/css">
    body {
  font-family: sans-serif;
}

.input-container {
  margin: 3em auto;
  max-width: 300px;
  background-color: #EDEDED;
  border: 1px solid #595959;
  border-radius: 5px;
}

input[type='file'] {
  display: none;
}

.file-info {
  font-size: 0.9em;
}

.browse-btn {

  color:   #595959;
  min-height: 35px;
  padding: 10px;
  border: none;
  border-top-left-radius: 5px;
  border-bottom-left-radius: 5px;
}

.browse-btn:hover {
  background: #4ec0b4;
}

@media (max-width: 300px) {
  button {
    width: 100%;
    border-top-right-radius: 5px;
    border-bottom-left-radius: 0;
  }
  
  .file-info {
    display: block;
    margin: 10px 5px;
  }
}

input[type='file'] {
  display: none;
}
</style>
{% endblock %}

